#!/usr/bin/env bash
set -x
CW=$PWD
mkdir notif-resource
echo "" > $CW/notif-resource/output-ci.txt
tail -f output-ci.txt&
./bin/ci &> $CW/notif-resource/output-ci.txt
exit_code=$?

if [ $exit_code -eq 0 ]; then
    echo "Pipeline $BUILD_PIPELINE_NAME with build $BUILD_NAME passed, see: $ATC_EXTERNAL_URL/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME" > $CW/notif-resource/slack-notification.txt
else
    echo "Pipeline $BUILD_PIPELINE_NAME with build $BUILD_NAME failed, see: $ATC_EXTERNAL_URL/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME" > $CW/notif-resource/slack-notification.txt
    echo "Result: "
    cat output-ci.txt >> $CW/notif-resource/slack-notification.txt
fi
exit $exit_code